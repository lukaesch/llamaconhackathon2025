<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Knowledge Graph Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-data@7.1.2/dist/vis-data.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <style>
        @keyframes shine {
            0% {
                left: -100%;
                opacity: 0;
            }
            10% {
                left: -100%;
                opacity: 0.5;
            }
            20% {
                left: 100%;
                opacity: 0;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-5deg); }
        }
        @keyframes highlightAnim {
            from { width: 0; }
            to { width: 100%; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .shine-effect:before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            animation: shine 6s infinite;
        }
        
        .typewriter {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 3.5s steps(40, end);
        }
        
        .magic-wand {
            display: inline-block;
            transform-origin: bottom right;
            animation: wave 2s infinite;
            margin-left: 5px;
        }
        
        .highlight {
            position: relative;
            display: inline-block;
        }
        
        .highlight:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            height: 30%;
            width: 100%;
            background-color: rgba(52, 152, 219, 0.3);
            z-index: -1;
            animation: highlightAnim 1s ease forwards;
        }

        /* Make sure we use full browser height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Use all available space */
        .full-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        
        /* Custom scrollbar for the left panel */
        .scrollable-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollable-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .scrollable-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .scrollable-panel::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div class="full-container">
        <header class="text-center py-4 px-5 bg-gradient-to-r from-gray-100 to-blue-50 shadow-md relative overflow-hidden shine-effect mx-3 my-2 rounded-xl">
            <h1 class="text-2xl font-bold tracking-tight">Podcast Knowledge Graph Explorer <span class="magic-wand">âœ¨</span></h1>
            <p class="mt-1 opacity-80">Discover insights from podcast conversations with AI-powered exploration</p>
        </header>
        
        <div class="flex flex-col md:flex-row gap-4 p-3 flex-grow overflow-hidden">
            <!-- Left Panel (30%) - Scrollable -->
            <div class="w-full md:w-[30%] bg-white p-4 rounded-xl shadow-sm overflow-y-auto scrollable-panel h-full">
                <h2 class="text-xl font-semibold mb-4">Ask a Question</h2>
                <div class="flex gap-2">
                    <input type="text" id="question" placeholder="What have podcasts revealed about..." 
                        class="flex-grow py-3 px-5 border-2 border-gray-200 rounded-full text-base transition-all duration-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    <button id="ask-button" 
                            class="bg-blue-500 text-white font-semibold py-3 px-5 rounded-full transition-all duration-300 hover:bg-blue-600 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0.5">
                        <span id="ask-text">Ask</span>
                        <span id="ask-loading" class="hidden">...</span>
                    </button>
                </div>
                
                <div id="loader" class="hidden w-8 h-8 mx-auto my-5 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin"></div>
                
                <div id="answer" class="py-5 px-4 mt-4 bg-gray-50 rounded-lg border-l-4 border-blue-500 shadow-sm opacity-0 transition-opacity duration-1000">
                    Ask me anything about topics discussed in podcasts!
                </div>
                
                <div id="error-message" class="hidden mt-4 p-4 bg-red-50 text-red-600 rounded-lg border-l-4 border-red-500 animate-[shake_0.5s]"></div>
                
                <div class="mt-6 p-4 bg-white rounded-xl shadow-sm">
                    <div class="flex items-center mb-2">
                        <span class="text-yellow-500 text-xl mr-2">ðŸ’¡</span>
                        <h3 class="font-semibold">Surprising facts from podcasts</h3>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="What companies has Elon Musk founded?">Elon Musk's companies</div>
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="What did Sam Altman say about AGI safety?">Sam Altman on AGI</div>
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="What did podcast hosts ask Mark Zuckerberg about Meta?">Zuckerberg on Meta</div>
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="What controversies has Joe Rogan been involved in?">Joe Rogan controversies</div>
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="How has AI changed in the last 5 years according to podcasts?">AI evolution</div>
                        <div class="suggestion-chip bg-blue-50 text-blue-500 px-4 py-2 rounded-full text-sm cursor-pointer border border-blue-100 transition-all hover:bg-blue-100 hover:-translate-y-0.5 hover:shadow-md" data-question="Who are the most mentioned tech CEOs in podcasts?">Popular tech CEOs</div>
                    </div>
                </div>
                
                <div class="flex mt-4 border-b border-gray-200">
                    <div class="tab active px-4 py-2 cursor-pointer bg-gray-100 border border-gray-200 border-b-0 rounded-t-lg mr-1 font-medium transition-colors hover:bg-gray-200 data-[active=true]:bg-blue-500 data-[active=true]:text-white data-[active=true]:border-blue-500" data-tab="cypher" data-active="true">Cypher Query</div>
                    <div class="tab px-4 py-2 cursor-pointer bg-gray-100 border border-gray-200 border-b-0 rounded-t-lg mr-1 font-medium transition-colors hover:bg-gray-200 data-[active=true]:bg-blue-500 data-[active=true]:text-white data-[active=true]:border-blue-500" data-tab="results" data-active="false">Raw Results</div>
                </div>
                
                <div class="tab-content active block p-4 bg-white border border-gray-200 border-t-0 rounded-b-lg max-h-[300px] overflow-auto animate-[fadeIn_0.3s]" id="cypher-tab" data-active="true">
                    <pre id="cypher-query" class="bg-gray-50 p-4 rounded-lg overflow-x-auto m-0 font-mono leading-relaxed">// Query will appear here after asking a question</pre>
                </div>
                
                <div class="tab-content hidden p-4 bg-white border border-gray-200 border-t-0 rounded-b-lg max-h-[300px] overflow-auto animate-[fadeIn_0.3s]" id="results-tab" data-active="false">
                    <pre id="raw-results" class="bg-gray-50 p-4 rounded-lg overflow-x-auto m-0 font-mono leading-relaxed">// Results will appear here after asking a question</pre>
                </div>
                
                <div class="node-details hidden mt-5 p-5 bg-white rounded-xl shadow-sm max-h-[200px] overflow-auto animate-[slideUp_0.3s]" id="node-details">
                    <h3 class="font-semibold">Node Details</h3>
                    <pre id="selected-node-data" class="mt-2 bg-gray-50 p-3 rounded-lg overflow-x-auto text-sm"></pre>
                    <button id="expand-node" class="mt-3 bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-all hover:bg-blue-600">Expand This Node</button>
                </div>
            </div>
            
            <!-- Right Panel (70%) - Fixed with internal scroll -->
            <div class="w-full md:w-[70%] flex flex-col h-full">
                <div class="flex-grow bg-white rounded-xl shadow-sm overflow-hidden relative">
                    <div id="graph" class="w-full h-full"></div>
                    <div class="absolute bottom-3 right-3 bg-white/90 py-2 px-3 rounded-full text-xs shadow-sm opacity-80 transition-opacity hover:opacity-100">
                        Tip: Click on nodes to explore connections
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3 mt-4">
                    <button id="reset-graph" class="w-full py-3 px-4 bg-gray-100 text-gray-600 font-medium rounded-lg shadow-sm hover:bg-gray-200 hover:text-blue-500 transition-colors flex items-center justify-center">Reset View</button>
                </div>
                
                <div class="flex flex-wrap gap-3 mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#e91e63] mr-2 shadow-sm"></div>
                        <div>Person</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#2196f3] mr-2 shadow-sm"></div>
                        <div>Organization</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#4caf50] mr-2 shadow-sm"></div>
                        <div>Product</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#f39c12] mr-2 shadow-sm"></div>
                        <div>Episode</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#9c27b0] mr-2 shadow-sm"></div>
                        <div>Podcast</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#009688] mr-2 shadow-sm"></div>
                        <div>Concept</div>
                    </div>
                    <div class="flex items-center mr-4 transition-transform hover:scale-105">
                        <div class="w-4 h-4 rounded-full bg-[#607d8b] mr-2 shadow-sm"></div>
                        <div>Other</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="magic-note" class="fixed bottom-5 right-5 bg-blue-500/90 text-white py-3 px-5 rounded-lg shadow-lg cursor-pointer z-50 transform translate-y-[100px] opacity-0 transition-all duration-500">
        Found something interesting! Click to explore.
    </div>
    
    <script>
        // DOM elements
        const questionInput = document.getElementById('question');
        const askButton = document.getElementById('ask-button');
        const askText = document.getElementById('ask-text');
        const askLoading = document.getElementById('ask-loading');
        const answerDiv = document.getElementById('answer');
        const errorMessageDiv = document.getElementById('error-message');
        const cypherQueryDiv = document.getElementById('cypher-query');
        const rawResultsDiv = document.getElementById('raw-results');
        const nodeDetailsDiv = document.getElementById('node-details');
        const selectedNodeDataDiv = document.getElementById('selected-node-data');
        const expandNodeButton = document.getElementById('expand-node');
        const resetGraphButton = document.getElementById('reset-graph');
        const loaderElement = document.getElementById('loader');
        const magicNote = document.getElementById('magic-note');
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        
        // Tab elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Vis.js network variables
        let network = null;
        let nodesDataset = new vis.DataSet();
        let edgesDataset = new vis.DataSet();
        
        // Interesting insights for questions
        const surpriseInsights = [
            "What are Elon Musk's views on AI safety?",
            "How do podcasters describe the future of blockchain?",
            "What health tips are most commonly shared on Joe Rogan's podcast?",
            "What has Bill Gates predicted about pandemics?",
            "What controversies surround OpenAI according to podcasts?",
            "What are the most discussed space exploration topics in podcasts?",
            "How do tech CEOs describe their morning routines?",
            "What do Silicon Valley entrepreneurs say about work-life balance?",
            "What predictions have been made about quantum computing?",
            "How has discussion about climate change evolved in podcasts?"
        ];
        
        // Optimized network options for faster rendering
        const options = {
            nodes: {
                shape: 'dot',
                size: 20, // Smaller size for better performance
                font: {
                    size: 14,
                    face: 'Inter',
                    color: '#333'
                },
                borderWidth: 2,
                shadow: {
                    enabled: false // Disable shadows for better performance
                }
            },
            edges: {
                font: {
                    size: 12,
                    align: 'middle',
                    face: 'Inter'
                },
                arrows: {
                    to: { enabled: true, scaleFactor: 0.5 }
                },
                smooth: { 
                    enabled: true,
                    type: 'dynamic', // Better for performance
                    roundness: 0.5
                },
                color: {
                    color: '#90A4AE',
                    highlight: '#607D8B',
                    hover: '#607D8B'
                },
                width: 1.5
            },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springLength: 100, // Reduced for faster convergence
                    springConstant: 0.15, // Increased for faster stabilization
                    damping: 0.5, // Increased damping for faster stabilization
                    avoidOverlap: 0.5 // Help prevent node overlap
                },
                stabilization: {
                    enabled: true,
                    iterations: 100, // Reduced for performance
                    updateInterval: 25, 
                    fit: true,
                    maxTime: 1000, // Limit stabilization to 1 second
                    onlyDynamicEdges: false
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                hideEdgesOnDrag: true,
                zoomView: true,
                navigationButtons: false, // Disable for cleaner UI
                keyboard: true
            },
            layout: {
                improvedLayout: false // Disable for better performance with large graphs
            }
        };
        
        // Currently selected node
        let selectedNodeId = null;
        
        // Animation timing
        const TYPING_SPEED = 30; // ms per character
        
        // Initialize network
        function initNetwork() {
            const container = document.getElementById('graph');
            const data = {
                nodes: nodesDataset,
                edges: edgesDataset
            };
            
            network = new vis.Network(container, data, options);
            
            // Network event listeners
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    selectedNodeId = params.nodes[0];
                    const node = nodesDataset.get(selectedNodeId);
                    
                    // Display node details with animation
                    nodeDetailsDiv.style.display = 'none';
                    setTimeout(() => {
                        nodeDetailsDiv.style.display = 'block';
                        selectedNodeDataDiv.textContent = JSON.stringify(node.properties || {}, null, 2);
                    }, 50);
                    
                    // Highlight the selected node
                    highlightNode(selectedNodeId);
                } else {
                    // Clicked outside any node
                    selectedNodeId = null;
                    nodeDetailsDiv.style.display = 'none';
                    // Reset all node colors
                    resetNodeHighlights();
                }
            });
            
            // Track stabilization progress
            network.on('stabilizationProgress', function(params) {
                const maxWidth = 496;
                const minWidth = 20;
                const widthFactor = params.iterations / params.total;
                const width = Math.max(minWidth, maxWidth * widthFactor);
            });
            
            // When stabilization is done - COMPLETELY DISABLE PHYSICS
            network.on('stabilizationIterationsDone', function() {
                // Completely disable physics to ensure graph doesn't move anymore
                network.setOptions({ 
                    physics: { 
                        enabled: false 
                    } 
                });
                
                // Fit the view with a consistent animation
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            });
            
            // Mouse cursor effects
            network.on('hoverNode', function(params) {
                document.body.style.cursor = 'pointer';
            });
            
            network.on('blurNode', function(params) {
                document.body.style.cursor = 'default';
            });
        }
        
        // Highlight a selected node and its connections
        function highlightNode(nodeId) {
            // First reset all nodes and edges
            resetNodeHighlights();
            
            // Get connected edges
            const connectedEdges = network.getConnectedEdges(nodeId);
            
            // Get connected nodes
            const connectedNodes = network.getConnectedNodes(nodeId);
            
            // Highlight the selected node
            const selectedNode = nodesDataset.get(nodeId);
            const originalColor = selectedNode.color ? selectedNode.color.background : '#4b5563';
            
            nodesDataset.update({
                id: nodeId,
                color: {
                    background: originalColor,
                    border: '#e74c3c',
                    highlight: {
                        background: originalColor,
                        border: '#e74c3c'
                    }
                },
                borderWidth: 3,
                size: 30
            });
            
            // Dim all other nodes
            nodesDataset.forEach((node) => {
                if (node.id !== nodeId && !connectedNodes.includes(node.id)) {
                    nodesDataset.update({
                        id: node.id,
                        opacity: 0.3
                    });
                }
            });
            
            // Highlight connected edges
            edgesDataset.forEach((edge) => {
                if (connectedEdges.includes(edge.id)) {
                    edgesDataset.update({
                        id: edge.id,
                        color: '#607D8B',
                        width: 2
                    });
                } else {
                    edgesDataset.update({
                        id: edge.id,
                        opacity: 0.3
                    });
                }
            });
        }
        
        // Reset node highlights
        function resetNodeHighlights() {
            nodesDataset.forEach((node) => {
                const originalColor = node.color ? node.color.background : '#4b5563';
                nodesDataset.update({
                    id: node.id,
                    color: {
                        background: originalColor,
                        border: '#2c3e50',
                        highlight: {
                            background: originalColor,
                            border: '#e74c3c'
                        }
                    },
                    borderWidth: 2,
                    size: 20, // Smaller size for performance
                    opacity: 1
                });
            });
            
            edgesDataset.forEach((edge) => {
                edgesDataset.update({
                    id: edge.id,
                    color: '#90A4AE',
                    width: 1.5,
                    opacity: 1
                });
            });
        }
        
        // Typewriter effect for answers
        function typeWriter(element, text, i = 0, cb = () => {}) {
            if (i === 0) {
                element.textContent = '';
                element.classList.add('typewriter');
            }
            
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(() => typeWriter(element, text, i, cb), TYPING_SPEED);
            } else {
                element.classList.remove('typewriter');
                cb();
            }
        }
        
        // Process graph data into vis.js format with optimized rendering
        function processGraphData(graphData) {
            // For very large graphs, apply performance optimizations
            const isLargeGraph = graphData.nodes && graphData.nodes.length > 50;
            
            // Disable physics during data load
            if (network) {
                network.setOptions({
                    physics: {
                        enabled: false
                    }
                });
            }
            
            // Clear existing data
            nodesDataset.clear();
            edgesDataset.clear();
            
            // Process nodes - prepare batch data
            const nodesToAdd = [];
            if (graphData.nodes && Array.isArray(graphData.nodes)) {
                graphData.nodes.forEach(node => {
                    // Determine node color based on type to match the legend
                    let color;
                    const nodeType = (node.type || "").toLowerCase();
                    
                    switch(nodeType) {
                        case 'person': color = '#e91e63'; break; // Red
                        case 'organization': color = '#2196f3'; break; // Blue
                        case 'product': color = '#4caf50'; break; // Green
                        case 'episode': color = '#f59e0b'; break; // Yellow
                        case 'podcast': color = '#9333ea'; break; // Purple
                        case 'concept': color = '#14b8a6'; break; // Teal
                        case 'entity': 
                            // For entities, check if they might be a more specific type
                            if (node.properties && node.properties.type) {
                                const entityType = node.properties.type.toLowerCase();
                                if (entityType === 'person') color = '#e91e63';
                                else if (entityType === 'organization') color = '#2196f3';
                                else if (entityType === 'product') color = '#4caf50';
                                else color = '#3f51b5'; // Default entity color
                            } else {
                                color = '#3f51b5'; // Default entity color
                            }
                            break;
                        default: color = '#4b5563'; break; // Gray for Other
                    }
                    
                    // For large graphs, simplify the node representation
                    const nodeOptions = {
                        id: node.id,
                        label: isLargeGraph ? (node.label.substring(0, 15) + (node.label.length > 15 ? '...' : '')) : node.label,
                        color: { 
                            background: color, 
                            border: '#2c3e50', 
                            highlight: { background: color, border: '#e74c3c' } 
                        },
                        font: { color: '#333' },
                        type: node.type,
                        properties: node.properties,
                        title: `Type: ${node.type}<br>ID: ${node.id}`,
                        // Visual differentiation for inferred nodes
                        borderDashes: node.inferred ? [5, 5] : false
                    };
                    
                    // For large graphs, further optimize rendering
                    if (isLargeGraph) {
                        nodeOptions.size = 15; // Smaller nodes
                        nodeOptions.font.size = 12; // Smaller font
                    }
                    
                    nodesToAdd.push(nodeOptions);
                });
                
                // Add all nodes at once (better performance)
                nodesDataset.add(nodesToAdd);
            }

            // Process edges - prepare batch data
            const edgesToAdd = [];
            if (graphData.edges && Array.isArray(graphData.edges)) {
                graphData.edges.forEach(edge => {
                    const edgeOptions = {
                        id: edge.id,
                        from: edge.from,
                        to: edge.to,
                        label: isLargeGraph ? '' : edge.label, // Hide labels in large graphs
                        properties: edge.properties,
                        title: `Relationship: ${edge.label}`,
                        // Visual differentiation for inferred edges
                        dashes: edge.inferred ? [5, 5] : false,
                        color: edge.inferred ? {color: '#999999', opacity: 0.7} : undefined
                    };
                    
                    // For large graphs, further optimize rendering
                    if (isLargeGraph) {
                        edgeOptions.width = 1; // Thinner edges
                        edgeOptions.arrows = { to: { enabled: false } }; // No arrows
                        edgeOptions.smooth = { enabled: false }; // Straight lines
                    }
                    
                    edgesToAdd.push(edgeOptions);
                });
                
                // Add all edges at once (better performance)
                edgesDataset.add(edgesToAdd);
            }
            
            // If network doesn't exist, initialize it
            if (!network) {
                initNetwork();
            } else {
                // Enable physics for 1-second stabilization and then freeze
                network.setOptions({
                    physics: {
                        enabled: true,
                        stabilization: {
                            enabled: true,
                            iterations: isLargeGraph ? 50 : 100, // Fewer iterations for large graphs
                            updateInterval: 25,
                            maxTime: 1000 // Strict 1-second time limit for stabilization
                        },
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: {
                            gravitationalConstant: -50,
                            centralGravity: 0.01,
                            springLength: 100,
                            springConstant: 0.15,
                            damping: 0.5
                        }
                    }
                });
                
                // After 1 second, physics will be disabled by the stabilizationIterationsDone event
            }
        }

        // Ask question and update UI with improved animations
       async function askQuestion(question = questionInput.value.trim()) {
            if (!question) return;
            
            try {
                // Update UI for loading state
                askText.style.display = 'none';
                askLoading.style.display = 'inline';
                loaderElement.style.display = 'block';
                answerDiv.innerHTML = '<div class="w-8 h-8 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mx-auto"></div>';
                answerDiv.classList.add('loading');
                errorMessageDiv.style.display = 'none';
                
                // Clear existing data
                if (cypherQueryDiv) cypherQueryDiv.textContent = '// Loading query...';
                if (rawResultsDiv) rawResultsDiv.textContent = '// Loading results...';
                nodeDetailsDiv.style.display = 'none';
                
                // Make API request
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update UI with responses
                answerDiv.classList.remove('loading');
                answerDiv.innerHTML = '';
                
                // Smooth animation for showing answer
                setTimeout(() => {
                    // Initialize markdown-it
                    const md = window.markdownit();
                    
                    // Check if the answer appears to contain markdown
                    const answer = data.answer || 'No answer generated.';
                    
                    // If answer contains markdown indicators, render it as markdown
                    if (answer.includes('**') || answer.includes('##') || 
                        answer.includes('```') || answer.includes('*') || 
                        answer.includes('[') || answer.includes('|')) {
                        answerDiv.innerHTML = md.render(answer);
                    } else {
                        // Otherwise use the highlight method for plain text
                        const formattedAnswer = addHighlights(answer);
                        answerDiv.innerHTML = formattedAnswer;
                    }
                    
                    answerDiv.style.opacity = 1;
                    
                    // Set other data
                    if (cypherQueryDiv) cypherQueryDiv.textContent = data.cypher_query || '// No query available';
                    if (rawResultsDiv) rawResultsDiv.textContent = JSON.stringify(data.results || {}, null, 2);
                    
                    // Show a magic notification occasionally
                    if (Math.random() > 0.7) {
                        setTimeout(showMagicNote, 3000);
                    }
                }, 300);
                
                // Display error if there is one
                if (data.error) {
                    errorMessageDiv.textContent = `Query Error: ${data.error}`;
                    errorMessageDiv.style.display = 'block';
                    answerDiv.classList.add('error');
                } else {
                    errorMessageDiv.style.display = 'none';
                    answerDiv.classList.remove('error');
                }
                
                // Visualize the graph with animation
                if (data.graph_data) {
                    processGraphData(data.graph_data);
                }
            } catch (error) {
                console.error('Error:', error);
                answerDiv.textContent = `Error: ${error.message}`;
                answerDiv.classList.remove('loading');
                answerDiv.classList.add('error');
                errorMessageDiv.textContent = `Error: ${error.message}`;
                errorMessageDiv.style.display = 'block';
            } finally {
                // Reset UI state
                askText.style.display = 'inline';
                askLoading.style.display = 'none';
                loaderElement.style.display = 'none';
            }
        } 
                
        // Add highlights to the answer text
        function addHighlights(text) {
            // Find entities to highlight (words starting with uppercase letters)
            const words = text.split(' ');
            let result = '';
            
            const commonWords = ['I', 'A', 'The', 'This', 'In', 'On', 'At', 'And', 'But', 'Or', 'For', 'With', 'About', 'To', 'From'];
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const strippedWord = word.replace(/[.,!?;:"'()]/g, '');
                
                // Check if it's a potential entity (capital letter, longer than 1 char, not a common word, not first word in sentence)
                if (strippedWord.length > 1 && 
                    /^[A-Z]/.test(strippedWord) && 
                    !commonWords.includes(strippedWord) && 
                    (i !== 0 && !words[i-1].endsWith('.') && !words[i-1].endsWith('?') && !words[i-1].endsWith('!'))) {
                    
                    // Check if multiple consecutive words are capitalized (like "Elon Musk")
                    let entityPhrase = word;
                    let j = i + 1;
                    while (j < words.length) {
                        const nextWord = words[j].replace(/[.,!?;:"'()]/g, '');
                        if (nextWord.length > 1 && /^[A-Z]/.test(nextWord) && !commonWords.includes(nextWord)) {
                            entityPhrase += ' ' + words[j];
                            j++;
                            i++;
                        } else {
                            break;
                        }
                    }
                    
                    result += `<span class="highlight">${entityPhrase}</span> `;
                } else {
                    result += word + ' ';
                }
            }
            
            return result;
        }
        
        // Expand a single entity node with visual feedback
        async function expandEntityNode(nodeId) {
            try {
                // Visual feedback
                const node = nodesDataset.get(nodeId);
                const originalColor = node.color ? node.color.background : '#4b5563';
                
                // "Loading" effect on the node
                nodesDataset.update({
                    id: nodeId,
                    color: { background: '#f8f9fa', border: '#3498db' },
                    size: 30
                });
                
                loaderElement.style.display = 'block';
                
                const response = await fetch(`/expand_entity/${nodeId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                
                // Restore original node appearance
                setTimeout(() => {
                    nodesDataset.update({
                        id: nodeId,
                        color: { 
                            background: originalColor, 
                            border: '#2c3e50',
                            highlight: { background: originalColor, border: '#e74c3c' }
                        },
                        size: 20
                    });
                }, 300);
                
                // Check if we're dealing with a large expansion
                const isLargeExpansion = data.nodes && data.nodes.length > 20;
                
                // Disable physics during data addition
                network.setOptions({ physics: { enabled: false } });
                
                // Add new nodes all at once for better performance
                if (data.nodes && Array.isArray(data.nodes)) {
                    // First collect all node IDs to add
                    const newNodeIds = new Set();
                    data.nodes.forEach(node => newNodeIds.add(node.id));
                    
                    // Filter out nodes that already exist
                    const existingNodeIds = new Set(nodesDataset.getIds().map(id => String(id)));
                    const nodesToAdd = data.nodes
                        .filter(node => !existingNodeIds.has(String(node.id)))
                        .map(node => {
                            let color;
                            switch(node.type.toLowerCase()) {
                                case 'person': color = '#e74c3c'; break;
                                case 'organization': color = '#3498db'; break;
                                case 'product': color = '#2ecc71'; break;
                                case 'location': color = '#f1c40f'; break;
                                case 'concept': color = '#1abc9c'; break;
                                case 'event': color = '#9b59b6'; break;
                                case 'episode': color = '#f39c12'; break;
                                case 'podcast': color = '#9b59b6'; break;
                                default: color = '#34495e'; // default gray
                            }
                            
                            // For large expansions, simplify nodes
                            return {
                                id: node.id,
                                label: isLargeExpansion ? 
                                    (node.label.substring(0, 15) + (node.label.length > 15 ? '...' : '')) : 
                                    node.label,
                                color: { 
                                    background: color, 
                                    border: '#2c3e50',
                                    highlight: { background: color, border: '#e74c3c' }
                                },
                                font: { 
                                    color: '#333',
                                    size: isLargeExpansion ? 10 : 14 
                                },
                                type: node.type,
                                properties: node.properties,
                                title: `Type: ${node.type}<br>ID: ${node.id}`,
                                size: isLargeExpansion ? 15 : 20
                            };
                        });
                    
                    if (nodesToAdd.length > 0) {
                        nodesDataset.add(nodesToAdd);
                    }
                }
                
                // Add new edges all at once for better performance
                if (data.edges && Array.isArray(data.edges)) {
                    // Filter out edges that already exist
                    const existingEdgeIds = new Set(edgesDataset.getIds().map(id => String(id)));
                    const edgesToAdd = data.edges
                        .filter(edge => !existingEdgeIds.has(String(edge.id || `${edge.from}_${edge.to}_${edge.label}`)))
                        .map(edge => ({
                            id: edge.id || `${edge.from}_${edge.to}_${edge.label}`,
                            from: edge.from,
                            to: edge.to,
                            label: isLargeExpansion ? '' : edge.label,
                            properties: edge.properties,
                            title: `Relationship: ${edge.label}`,
                            width: isLargeExpansion ? 1 : 1.5,
                            smooth: isLargeExpansion ? { enabled: false } : { enabled: true, type: 'dynamic' }
                        }));
                    
                    if (edgesToAdd.length > 0) {
                        edgesDataset.add(edgesToAdd);
                    }
                }
                
                // Enable physics for exactly 1 second to stabilize, then disable
                network.setOptions({ 
                    physics: { 
                        enabled: true,
                        stabilization: {
                            enabled: true,
                            iterations: isLargeExpansion ? 50 : 100,
                            updateInterval: 25,
                            maxTime: 1000
                        }
                    }
                });
                
                // Focus on the expanded node
                network.focus(nodeId, { 
                    scale: 1, 
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
                
                // After 1 second, the stabilizationIterationsDone event will disable physics
                
            } catch (error) {
                console.error('Error expanding node:', error);
                alert(`Error expanding node: ${error.message}`);
            } finally {
                loaderElement.style.display = 'none';
            }
        }
        
        // Reset graph view with animation
        function resetGraphView() {
            // First reset all highlights
            resetNodeHighlights();
            
            // Then animate to fit view without enabling physics
            network.fit({
                animation: {
                    duration: 1000,
                    easingFunction: 'easeInOutQuad'
                }
            });
        }
        
        // Show magic notification
        function showMagicNote(text) {
            const noteText = text || 'I found something interesting! Click to explore more.';
            magicNote.textContent = noteText;
            magicNote.classList.add('show');
            magicNote.style.transform = 'translateY(0)';
            magicNote.style.opacity = 1;
            
            setTimeout(() => {
                magicNote.style.transform = 'translateY(100px)';
                magicNote.style.opacity = 0;
            }, 5000);
        }
        
        // Ask a random question from the insights list
        function askRandomInsight() {
            const randomIndex = Math.floor(Math.random() * surpriseInsights.length);
            const randomQuestion = surpriseInsights[randomIndex];
            questionInput.value = randomQuestion;
            
            // Add some animation to the input
            questionInput.style.backgroundColor = '#f8f9fa';
            setTimeout(() => {
                questionInput.style.backgroundColor = '';
                askQuestion(randomQuestion);
            }, 300);
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize network
            initNetwork();
            
            // Ask button
            askButton.addEventListener('click', () => askQuestion());
            
            // Enter key in input
            questionInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    askQuestion();
                }
            });
            
            // Expand node button
            expandNodeButton.addEventListener('click', function() {
                if (selectedNodeId) {
                    expandEntityNode(selectedNodeId);
                } else {
                    alert('No node selected.');
                }
            });
            
            // Reset graph button
            resetGraphButton.addEventListener('click', resetGraphView);
            
            // Magic note click
            magicNote.addEventListener('click', askRandomInsight);
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('data-active', 'false');
                    });
                    tabContents.forEach(c => {
                        c.classList.add('hidden');
                        c.classList.remove('block');
                        c.setAttribute('data-active', 'false');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    this.setAttribute('data-active', 'true');
                    
                    // Show corresponding tab content
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    if (tabContent) {
                        tabContent.classList.remove('hidden');
                        tabContent.classList.add('block');
                        tabContent.setAttribute('data-active', 'true');
                    }
                });
            });
            
            // Suggestion chips
            suggestionChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    questionInput.value = question;
                    askQuestion(question);
                });
            });
            
            questionInput.value = "";
            
            // Show tutorial notification after a moment
            setTimeout(() => {
                showMagicNote("Welcome to the Podcast Knowledge Explorer! Click 'Ask' to start or try one of the suggested topics.");
            }, 1500);
        });
    </script>
</body>
</html>
